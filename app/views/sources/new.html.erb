<!DOCTYPE html>
<html lang="en">
<head>
  <title>Fact Entry</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<div id="wrapper" class="container">
    <h1>Fact Entry</h1>
    <hr>
    <h4>Enter Source Info</h4>

    <body ng-controller="ItemController">
    <%= javascript_tag do %>
        var items = <%= @source.facts.to_json.html_safe %>;
    <% end %>
    <%= form_for @source do |f| %>

        <p>
          <%= f.label :url %>
          <%= f.text_field :url %>
        </p>

        <p>
          <%= f.label :title %>
          <%= f.text_field :title %>
        </p>

        <p>
          <%= f.label :authors %>
          <%= f.text_field :authors %>
        </p>

        <p>
          <%= f.label :date_published %>
          <%= f.date_select :date_published, {:start_year => 1970, :end_year => Time.now.year} %>
        </p>

        <p>
          <%= f.label :original_source %>
          <%= f.select :original_source, Source::ORIG_SOURCE_OPTIONS.map { |s| "#{s}" } %>
        </p>

        <% f.fields_for :facts do |builder| %>

            <%= render 'fact_fields', :f => builder %>

        <% end %>



      <table class="table">
        <tr>
          <th></th>
          <th>Fact</th>
          <th>Notes</th>
        </tr>

        <tr ng-repeat="item in items track by $index" ng-if="!item.removed">
          <td><i class="glyphicon glyphicon-minus" ng-click="item.removed = true"></i></td>
          <td>{{items.length}}</td>
          <td>[{{$index + 1}}]</td>
          <td>
              <input name="source[facts_attributes][$index][id]" type="hidden" ng-value="item.id" ng-if="item.id"/>
              <input name="source[facts_attributes][$index][fact_text]" type="text" ng-model="item.fact_text" />
          </td>
          <td><input name="source[facts_attributes][$index][notes]" type="text" ng-model="item.notes" /></td>
        </tr>
        <tr>
          <td colspan="3">
            <i class="glyphicon glyphicon-plus" ng-click="items.push({})"> Add a fact for this source</i>
          </td>
        </tr>
      </table>

      <div style="display: none" ng-repeat="item in items track by $index"
           ng-if="item.removed && item.id">
        <input type="hidden" name="source[facts_attributes][$index][id]" ng-value="item.id"/>
        <input type="hidden" name="sources[facts_attributes][$index][_destroy]" value="1"/>
      </div>
      <br>
      <p><%= f.submit %></p>



    <% end %>

    <%= link_to 'Back', sources_path %>

    </body>
</div>